name: Build Packages

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Rebuild all packages'
        required: false
        default: false
        type: boolean
  workflow_call:
    inputs:
      force_rebuild:
        description: 'Rebuild all packages'
        required: false
        default: false
        type: boolean

permissions:
  packages: write
  contents: write

concurrency:
  group: "build-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  analyze:
    runs-on: ubuntu-latest
    outputs:
      levels: ${{ steps.manager.outputs.levels }}
      level_map: ${{ steps.manager.outputs.level_map }}
      packages_with_local_deps: ${{ steps.manager.outputs.packages_with_local_deps }}
      target_packages: ${{ steps.manager.outputs.target_packages }}
      publish: ${{ steps.check_publish.outputs.publish }}
      
      packager: ${{ steps.config.outputs.packager }}
      enc-gpg: ${{ steps.config.outputs.enc-gpg }}
      repo-name: ${{ steps.config.outputs.repo-name }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive
      
      - id: config
        uses: ./.github/actions/load-config

      - name: Install Python Dependencies
        run: pip install networkx

      - name: Update pkgver in PKGBUILDs
        run: |
           set -e
           # Use archlinux container to run makepkg and update pkgver in PKGBUILDs
           # We need git installed and a non-root user
           # This is neccessary because some PKGBUILDs compute pkgver dynamically from git tags or commits
           docker run --rm -v "$PWD":/work -w /work archlinux:base-devel /bin/bash -c '
             pacman -Sy --noconfirm git
             useradd -m builder
             chown -R builder /work
             su builder -c "git config --global --add safe.directory /work"
             su builder -c "find . -name PKGBUILD -print0 | while IFS= read -r -d \"\" file; do
               dir=\$(dirname \"\$file\")
               echo \"Updating pkgver for \$dir...\"
               (cd \"\$dir\" && makepkg --nobuild --nodeps --ignorearch || true)
             done"
           '
           # Restore permissions
           sudo chown -R $USER .

      - name: Determine Strategy
        id: check_publish
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "publish=true" >> $GITHUB_OUTPUT
          else
            echo "publish=false" >> $GITHUB_OUTPUT
          fi

      - name: Analyze Changes
        id: manager
        run: |
          set -e
          FORCE_FLAG=""
          if [[ "${{ inputs.force_rebuild }}" == "true" ]]; then
            FORCE_FLAG="--force"
          fi
          
          python3 .github/scripts/manage_packages.py $FORCE_FLAG --repo-name "${{ steps.config.outputs.repo-name }}"
          
          # Validate outputs were set
          if [ ! -f "$GITHUB_OUTPUT" ] || ! grep -q "^levels=" "$GITHUB_OUTPUT"; then
            echo "ERROR: manage_packages.py did not produce expected outputs"
            exit 1
          fi

  build-levels:
    needs: analyze
    if: needs.analyze.outputs.levels != '[]'
    strategy:
      max-parallel: 1
      fail-fast: true
      matrix:
        level: ${{ fromJson(needs.analyze.outputs.levels) }}
    uses: ./.github/workflows/build-level.yml
    with:
      packages: ${{ toJson(fromJson(needs.analyze.outputs.level_map)[format('{0}', matrix.level)]) }}
      packages_with_local_deps: ${{ needs.analyze.outputs.packages_with_local_deps }}
      packager: ${{ needs.analyze.outputs.packager }}
      enc_gpg: ${{ needs.analyze.outputs.enc-gpg }}
      publish: ${{ needs.analyze.outputs.publish == 'true' }}
    secrets:
      GPG_FILE_PASSWORD: ${{ secrets.GPG_FILE_PASSWORD }}
      GPG_KEY_PASSWORD: ${{ secrets.GPG_KEY_PASSWORD }}

  update-repo:
    runs-on: ubuntu-latest
    needs:
      - analyze
      - build-levels
    if: always() && needs.analyze.outputs.publish == 'true' && needs.analyze.outputs.target_packages != '{}' && (needs.build-levels.result == 'success' || needs.build-levels.result == 'skipped')
    steps:
      - uses: actions/checkout@v6
      
      - name: Get current packages
        uses: robinraju/release-downloader@v1.12
        with:
          latest: true
          fileName: '*.pkg.*'
          tarBall: false
          zipBall: false
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Install zstd
        run: |
          if ! command -v zstd &>/dev/null; then
            sudo apt-get update -qq && sudo apt-get install -y -qq zstd
          fi

      - name: Reconcile assets against target state
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_PACKAGES: ${{ needs.analyze.outputs.target_packages }}
        run: |
          set -e
          # Determine which downloaded assets are stale
          python3 .github/scripts/cleanup_assets.py \
            --target-packages "$TARGET_PACKAGES" \
            --assets-dir .

          # Delete stale assets from the GitHub release
          if [ -s delete.txt ]; then
            echo "Deleting stale assets from release..."
            while IFS= read -r asset; do
              [ -z "$asset" ] && continue
              echo "  Deleting: $asset"
              gh release delete-asset repository "$asset" -R "$GITHUB_REPOSITORY" -y 2>/dev/null || true
            done < delete.txt

            # Also remove the stale files locally so repo-add only sees current packages
            while IFS= read -r asset; do
              [ -z "$asset" ] && continue
              rm -f "$asset"
            done < delete.txt
          else
            echo "No stale assets to delete."
          fi
          
      - name: Build Repo Database
        uses: ./.github/actions/archlinux
        env:
          PACKAGER: ${{ needs.analyze.outputs.packager }}
          GPG_FILE_PASSWORD: ${{ secrets.GPG_FILE_PASSWORD }}
          GPGKEY: ${{ needs.analyze.outputs.enc-gpg }}
          GPG_KEY_PASSWORD: ${{ secrets.GPG_KEY_PASSWORD }}
          REPO_NAME: ${{ needs.analyze.outputs.repo-name }}
        with:
          run: repo-add -s -q --nocolor -n -R ${{ needs.analyze.outputs.repo-name }}.db.tar.gz *.pkg.tar.zst
          
      - name: Upload new repo db
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: repository
          file: ${{ needs.analyze.outputs.repo-name }}.db*
          file_glob: true
          overwrite: true
