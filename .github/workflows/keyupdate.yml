name: Update Signing Key

on:
  push:
    branches:
      - master
    paths:
      - '.github/workflows/keyupdate.yml'
  schedule:
    - cron: '15 1 * * 1'

permissions:
  packages: write
  contents: write
  actions: write

concurrency:
  group: "release"

jobs:
  variables:
    runs-on: ubuntu-latest
    outputs:
      enc-gpg: ${{ steps.config.outputs.enc-gpg }}
      pub-gpg: ${{ steps.config.outputs.pub-gpg }}
      email: ${{ steps.config.outputs.email }}
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: recursive
        ref: master
    - id: config
      uses: ./.github/actions/load-config

  updateExpiry:
    runs-on: ubuntu-latest
    needs: variables
    outputs:
      update: ${{ steps.check.outputs.update }}
    steps:
      - uses: actions/checkout@v6
      - id: vars
        run: |
          if [ -z "${{ secrets.GPG_FILE_PASSWORD }}" ]; then
            echo "run=false" >> $GITHUB_OUTPUT
          else
            echo "run=true" >> $GITHUB_OUTPUT
          fi
      - name: Import Keys
        env:
          GPG_PASSWORD: ${{ secrets.GPG_KEY_PASSWORD }}
        if: ${{ steps.vars.outputs.run == 'true' }}
        run: |
          if [ -z "$GPG_PASSWORD" ]; then
            openssl aes-256-cbc -d -a -pbkdf2 -in ${{ needs.variables.outputs.enc-gpg }} -pass pass:${{ secrets.GPG_FILE_PASSWORD }} | gpg --import
          else
            echo "allow-preset-passphrase" | gpg-connect-agent --agent-program /usr/bin/gpg-agent
            openssl aes-256-cbc -d -a -pbkdf2 -in ${{ needs.variables.outputs.enc-gpg }} -pass pass:${{ secrets.GPG_FILE_PASSWORD }} | gpg --import
            KGRIPS=$(gpg --list-secret-keys --with-colons --with-keygrip | awk -F: '$1 == "grp" {print $10}')
            for KGRIP in $KGRIPS; do
              echo "$GPG_PASSWORD" | /usr/lib/gnupg/gpg-preset-passphrase --preset "${KGRIP}"
            done
          fi

          if [ -f "${{ needs.variables.outputs.pub-gpg }}" ]; then
            cat ${{ needs.variables.outputs.pub-gpg }} | gpg --import
          fi
      - id: check
        if: ${{ steps.vars.outputs.run == 'true' }}
        run: |
          keyId=$(gpg --list-secret-keys --keyid-format=long ${{ needs.variables.outputs.email }} | grep 'sec' | awk 'match($0, /[0-9A-Z]{16}/) {print substr($0, RSTART, RLENGTH)}')
          echo "keyId=$keyId" >> $GITHUB_OUTPUT
          
          expiry=`gpg --list-secret-keys --keyid-format=long ${{ needs.variables.outputs.email }} | grep 'sec' | awk 'match ($6, /[0-9-]{10}/){print substr($6, RSTART, RLENGTH)}'`
          echo "Key Expires on ${expiry}"
          dtSec=$(date --date "$expiry" +'%s')
          taSec=$(date --date "30 days" +'%s')
          if [ $dtSec -lt $taSec ]; then
            echo "update=true" >> $GITHUB_OUTPUT
          else
            echo "update=false" >> $GITHUB_OUTPUT
          fi
      - name: Update Expiry
        if: ${{ steps.check.outputs.update == 'true' }}
        run: |
          gpg --batch --command-fd 0 --edit-key ${{ steps.check.outputs.keyId }} <<-END
          expire
          3m
          save
          END
      - name: Export Keys
        if: ${{ steps.check.outputs.update == 'true' }}
        run: |
          rm ${{ needs.variables.outputs.enc-gpg }} ${{ needs.variables.outputs.pub-gpg }}
          gpg --armor --export-secret-key ${{ steps.check.outputs.keyId }} | openssl aes-256-cbc -a -salt -pbkdf2 -out ${{ needs.variables.outputs.enc-gpg }} -pass pass:${{ secrets.GPG_FILE_PASSWORD }}
          gpg --batch --output ${{ needs.variables.outputs.pub-gpg }} --armor --export ${{ steps.check.outputs.keyId }}
      - name: Push Changes
        if: ${{ steps.check.outputs.update == 'true' }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ${{ needs.variables.outputs.enc-gpg }} ${{ needs.variables.outputs.pub-gpg }}
          git commit -m "Update GPG Key"
          git push -u origin master

  trigger-rebuild:
    runs-on: ubuntu-latest
    needs: updateExpiry
    if: ${{ needs.updateExpiry.outputs.update == 'true' }}
    steps:
      - name: Trigger Full Rebuild
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run main.yml --ref master -f force_rebuild=true
